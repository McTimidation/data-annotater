{% extends "data_annotater/base.html" %}
{% block title %}Upload CSV{% endblock %}

{% block content %}
  <h2>Upload CSV</h2>

  <form method="post" enctype="multipart/form-data" class="card">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary" type="submit">Submit</button>
  </form>

  {% if stats %}
    <div class="card">
      <h3>Ingestion Results</h3>
      <ul>
        <li><strong>Created:</strong> {{ stats.created }}</li>
        <li><strong>Skipped (duplicates):</strong> {{ stats.skipped }}</li>
        <li><strong>Invalid rows:</strong> {{ stats.invalid }}</li>
        <li><strong>Errors:</strong> {{ stats.errors }}</li>
      </ul>

      {% if stats.error_samples %}
        <details>
          <summary>Show error samples</summary>
          <ul>
            {% for e in stats.error_samples %}
              <li>{{ e }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}
    </div>
  {% endif %}

  <h2>Records</h2>
  <p class="muted">
    {% if show_all %}
      Showing all records.
    {% else %}
      Showing records where retailer or segment is blank.
    {% endif %}
  </p>
  <p>
    {% if show_all %}
      <a class="btn btn-secondary" href="{% url 'data_annotater:upload' %}">Show Needing Annotation</a>
    {% else %}
      <a class="btn btn-secondary" href="{% url 'data_annotater:upload' %}?view=all">Show All</a>
    {% endif %}
  </p>

  {% if rows %}
    <table>
      <thead>
        <tr>
          <th>Merchant</th>
          <th>SKU</th>
          <th>Country</th>
          <th>Retailer</th>
          <th>Segment</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <td>{{ row.merchant }}</td>
            <td>{{ row.sku }}</td>
            <td>{{ row.country }}</td>
            <td>{{ row.retailer|default:"" }}</td>
            <td>{{ row.segment|default:"" }}</td>
            <td>
              <a class="btn btn-secondary" href="{% url 'data_annotater:edit' row.pk %}">Annotate</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endblock %}
